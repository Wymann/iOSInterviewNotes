## 内存管理

### 1 内存分配

iOS中的数据是存在堆和栈中的。而开发中需要管理的是在堆上的内存。

**堆(heap)**：是由工程师负责分配和管理，用于存储OC对象，比方说继承自NSObject的所有对象，这些对象都是引用类型。

**栈(stack)**：是由系统负责管理。存储类型Int，Float等值类型。栈的效率会高一些。栈的压栈和出栈只需要O(1)。



```objective-c
//存在栈中
int testInt = 2;
float testFloat = 3.0;
    
NSLog(@"值类型的指针地址 %p %p", &testInt, &testFloat);
    
//存在堆中
TestObject *object = [[TestObject alloc] init];
    
NSLog(@"引用计数 = %lu， 对象的内存 = %p，指针的地址 = %p", (unsigned long)object.retainCount, object, &object);
```

输出结果

```
2020-06-23 00:33:42.710729+0800 test11[2195:98602] 值类型的指针地址 0x7ffeeefd915c 0x7ffeeefd9158
2020-06-23 00:33:42.710981+0800 test11[2195:98602] 引用计数 = 1， 对象的内存 = 0x6000018ec290，指针的地址 = 0x7ffeeefd9150
```







### 2 引用计数  Reference Counting

iOS的内存管理，采用的是引用计数的模式。

引用计数是计算机编程语言中的一种内存管理技术，将资源的被引用次数保存起来，当引用次数变为0时就将其释放。

在iOS中，当创建一个对象实例，并且在堆上申请内存时，对象的引用计数就为1，在其他对象中需要持有这个对象时，将引用计数加1。需要释放时，将引用计数减1，直到引用计数为0，对象的内存就会被释放。



### 3 ARC和MRC

iOS中有两种内存管理方式

MRC：手动管理引用计数。

ARC：自动管理引用计数，由LLVM编译器和OC运行时库生成对应的内存管理的代码。



#### 3.1 MRC手动管理引用计数

在MRC中增加的引用计数都是需要手动释放，以下是会引起引用计数发生变化的操作

| 对象操作       | OC中对应的方法               | 引用计数的变化 |
| -------------- | ---------------------------- | -------------- |
| 生成并持有对象 | alloc/new/copy/mutableCopy等 | +1             |
| 主动持有对象   | retain                       | +1             |
| 释放对象       | release                      | -1             |
| 销毁对象       | dealloc                      | -              |

总结有以下四种原则：

- 自己生成的对象，自己持有
- 非自己生成的对象，自己也能持有
- 不再需要自己持有对象时释放
- 不是自己持有的对象无法释放

通过代码来描述上述的四种情况：

```objective-c
id obj0 = [[NSObject all] init];
id obj1 = [NSObject new]; 
```

